<script type="text/javascript">
    (function () {

        const DEFAULT_TABLE_WIDTH = 200;
        const DEFAULT_TABLE_HEIGHT = 160;
        const DEFAULT_TABLE_ROWS = 10;

        const TABLE_MARGINS = {
            left: 30,
            right: 10,
            bottom: 30,
            top: 15
        };

        RED.nodes.registerType('table-viewer', {
            category: 'output',
            color: '#88A882',
            defaults: {
                name: { value: "" },
                property: {
                    value: "payload",
                    required: true,
                    validate: RED.validators.typedInput("fieldType")
                },
                fieldType: {value:"msg"},
                width: {
                    value: DEFAULT_TABLE_WIDTH,
                    required: true,
                    validate: function (v) { return !v || !isNaN(parseInt(v, 10)) }
                },
                height: {
                    value: DEFAULT_TABLE_HEIGHT,
                    required: true,
                    validate: function (v) { return !v || !isNaN(parseInt(v, 10)) }
                },
                rows: {
                    value: DEFAULT_TABLE_ROWS,
                    required: true,
                    validate: function (v) { return !v || !isNaN(parseInt(v, 10)) }
                },
                active: { value: true },
                outputs: { value: 0 }
            },
            inputs: 1,
            outputs: 0,
            icon: "font-awesome/fa-table",
            align: 'right',
            label: function () {
                return this.name || 'msg.'+this.property;
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            button: {
                toggle: "active",
                visible: function () { return true; },
                onclick: function () {
                    const label = this.name || "table viewer";
                    var node = this;
                    $.ajax({
                        url: `table-viewer/${this.id}/${this.active ? 'enable' : 'disable'}`,
                        type: "POST",
                        success: function (resp, textStatus, xhr) {
                            const historyEvent = {
                                t: 'edit',
                                node: node,
                                changes: {
                                    active: !node.active
                                },
                                dirty: node.dirty,
                                changed: node.changed
                            };
                            node.changed = true;
                            node.dirty = true;
                            RED.nodes.dirty(true);
                            RED.history.push(historyEvent);
                            RED.view.redraw();
                            redraw(node);
                            if (xhr.status == 200) {
                                RED.notify("Successfully " + resp + ": " + label, "success");
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            var message;

                            switch (jqXHR.status) {
                                case 404:
                                    message = "node not deployed";
                                    break;
                                case 0:
                                    message = "no response from server";
                                    break;
                                default:
                                    message = `unexpected error (${textStatus}) ${errorThrown}`;
                            }

                            RED.notify(`<strong>Error</strong>: ${message}`, "error");
                        }
                    });
                }
            },
            oneditprepare: function () {
                var that = this;
                $('#node-input-property').typedInput({
                    default: 'msg',
                    typeField: $("#node-input-fieldType"),
                    types: ['msg']
                });
                $('#node-input-property').typedInput('value', this.property || 'payload');
            }
        });

        const latestData = {};

        var remove = function(id) {
            const $table = document.getElementById(`table-viewer-output-table-${id}`);
            const $bubble = document.getElementById(`table-viewer-output-bubble-${id}`);
            
            $bubble && $bubble.remove();
            $table && $table.remove();
        }

        var reset = function (id) {
            remove(id)
            delete latestData[id];
        }

        var redraw = function (node) {
            let id = node.id
            console.log(id)
            remove(id);
            if (latestData[id] && node.active) {
                render(id, latestData[id], node);
            }
        }


        var render = function (id, data, node) {
            console.log('render');
            let $table = document.getElementById("table-viewer-output-table-" + id);
            let tableWidth = node.width ? parseInt(node.width) : DEFAULT_CHART_WIDTH;
            let tableHeight = node.height ? parseInt(node.height) : DEFAULT_CHART_HEIGHT;

            console.log('set table');
            if (!$table) {
                // create table
                const $container = document.getElementById(id)
                if (!$container) { return }

                // build the out layer
                const bubble = document.createElementNS("http://www.w3.org/2000/svg", 'polyline')
                bubble.setAttribute('id', "table-viewer-output-bubble-" + id)
                bubble.setAttribute('style', 'fill:#E8F0E8')
                bubble.setAttribute('stroke', '#999999')
                chartBB = {
                    x: 0,
                    y: 45,
                    width: tableWidth,
                    height: tableHeight
                }

                const left = chartBB.x;
                const top = chartBB.y + 2;
                const right = chartBB.x + chartBB.width;
                const bottom = chartBB.y + chartBB.height;

                const points =
                    `${left + 4},${top - 17} ${left + 4},${top} ` +
                    `${right},${top} ${right},${bottom} ` +
                    `${left},${bottom} ${left},${top - 21}`;

                bubble.setAttribute('points', points);
                $container.insertBefore(bubble, $container.lastChild.nextSibling)

                console.log('create table 2');
                const tableGroup = document.createElementNS("http://www.w3.org/2000/svg", 'g');
                tableGroup.setAttribute('id', `table-viewer-output-table-${id}`);
                $container.insertBefore(tableGroup, $container.lastChild.nextSibling);

                console.log('create table 3');
                var data = new Array();
                var xpos = 1; //starting xpos and ypos at 1 so the stroke will show when we make the grid below
                var ypos = 1;
                var width = tableWidth/5;
                var height = tableHeight/5;

                // iterate for rows 
                for (var row = 0; row < 10; row++) {
                    data.push( new Array() );

                    // iterate for cells/columns inside rows
                    for (var column = 0; column < 10; column++) {
                        data[row].push({
                            x: xpos,
                            y: ypos,
                            width: width,
                            height: height
                        })
                        // increment the x position. I.e. move it over by 50 (width variable)
                        xpos += width;
                    }
                    // reset the x position after a row is complete
                    xpos = 1;
                    // increment the y position for the next row. Move it down 50 (height variable)
                    ypos += height; 
                }
                console.log(data);
                let d3table = d3.select(tableGroup);

                d3table.attr("transform", `translate(${4},${50})`);
                
                var grid =d3table.append("svg")
                    .attr("width", tableWidth)
                    .attr("height", tableHeight)
                    .attr("viewBox", [0, 0, tableWidth, tableHeight]);
                    

                var row = grid.selectAll(".row")
                    .data(data)
                    .enter()
                    .append("g")
                    .attr("class", "row")
                    .append("g")
                    .attr("class", "column");
                    
                var column = row.selectAll(".square")
                    .data(function(d) { return d; })
                    .enter()
                    .append("rect")
                    .attr("class","square")
                    .attr("x", function(d) { return d.x; })
                    .attr("y", function(d) { return d.y; })
                    .attr("width", function(d) { return d.width; })
                    .attr("height", function(d) { return d.height; })
                    .style("fill", "#fff")
                    .style("stroke", "#222");

                var columnText = row.selectAll(".column")  // select .column val from data
                    .data(function(d) { return d; })
                    .enter()
                    .append("text")
                    .text("a")
                    .attr("x", function(d) { return d.x+10; })
                    .attr("y", function(d) { return d.y+10; })
                    .style("fill", "red")
                    .style("font-size", "15");
                
/*
                var tt = d3table.append('table').attr("x", 20)
                    .attr("y", 20);
;

                var thead = tt.append('thead').attr("class", "table columns");
                var tbody = tt.append('tbody').attr("class", "table body");

                console.log('create table 4');

                thead.append("tr")
                    .selectAll("th")
                    .data(data[0])
                    .enter().append("th")
                    .text(function(d) { return d; })
                    .style("border", "1px black solid")
                    .style("padding", "5px")
                    .style("background-color", "lightgray")
                    .style("font-weight", "bold")
                    .style("text-transform", "uppercase");
                    console.log('create table 5');

                var rows = tbody.selectAll("tr")
                    .data(data.slice(1))
                    .enter().append("tr")
                    .selectAll("td")
                    .data(function(d){return d;})
                    .enter().append("td")
                    .style("border", "1px black solid")
                    .style("padding", "5px")
                    //.on("mouseover", function(){
                    //    d3.select(this).style("background-color", "powderblue");
                    //})
                    //.on("mouseout", function(){
                    //    d3.select(this).style("background-color", "white");
                    //})
                    .text(function(d){return d;})
                    .style("font-size", "12px");    
                
                // headers
                /*
                d3table.append("thead").append("tr")
                    .selectAll("th")
                    .data(data[0])
                    .enter().append("th")
                    .text(function(d) { return d; })
                    .style("border", "1px black solid")
                    .style("padding", "5px")
                    .style("background-color", "lightgray")
                    .style("font-weight", "bold")
                    .style("text-transform", "uppercase");
                    console.log('create table 5');
                // data
                d3table.append("tbody")
                    .selectAll("tr").data(data.slice(1))
                    .enter().append("tr")
                    .selectAll("td")
                    .data(function(d){return d;})
                    .enter().append("td")
                    .style("border", "1px black solid")
                    .style("padding", "5px")
                    //.on("mouseover", function(){
                    //    d3.select(this).style("background-color", "powderblue");
                    //})
                    //.on("mouseout", function(){
                    //    d3.select(this).style("background-color", "white");
                    //})
                    .text(function(d){return d;})
                    .style("font-size", "12px");    
                    console.log('create table 6');
*/
                console.log(d3table);
                console.log(tableGroup);
                $table = tableGroup;
                console.log($container);
            } else {
                console.log('update table');
                let d3table = d3.select($table).transition();


                // headers
                d3table.append("thead").append("tr")
                    .selectAll("th")
                    .data(data[0])
                    .enter().append("th")
                    .text(function(d) { return d; })
                    .style("border", "1px black solid")
                    .style("padding", "5px")
                    .style("background-color", "lightgray")
                    .style("font-weight", "bold")
                    .style("text-transform", "uppercase");

                // data
                d3table.append("tbody")
                    .selectAll("tr").data(data.slice(1))
                    .enter().append("tr")
                    .selectAll("td")
                    .data(function(d){return d;})
                    .enter().append("td")
                    .style("border", "1px black solid")
                    .style("padding", "5px")
                    //.on("mouseover", function(){
                    //    d3.select(this).style("background-color", "powderblue");
                    //})
                    //.on("mouseout", function(){
                    //    d3.select(this).style("background-color", "white");
                    //})
                    .text(function(d){return d;})
                    .style("font-size", "12px");
            }
        }

        RED.comms.subscribe('table-viewer', function (event, data) {

            if (data.hasOwnProperty("data")) {
                if (!latestData[data.id]) {
                    latestData[data.id] = [];
                }

                let numRows = node.rows ? parseInt(node.rows) : DEFAULT_TABLE_ROWS;
                console.log(data);
                console.log(data.data);
                tableData = data.data.subarray(0, numRows);
                latestData[data.id].push(tableData);
                console.log(tableData);
                render(data.id, tableData, node);
            } else {
                remove(data.id);
            }
        })
    })();
</script>

<script type="text/html" data-template-name="table-viewer">
    <div class="form-row">
        <label style="padding-top: 8px" for="node-input-property"><i class="fa fa-ellipsis-h"></i> Property</label>
        <input type="text" id="node-input-property" style="width:70%">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row">
        <label for="node-input-height"><i class="fa fa-arrows-v"></i>&nbsp;Height</label>
        <input type="number" id="node-input-height" style="width:125px !important">
        &nbsp;&nbsp;<i class="fa fa-arrows-h"></i>&nbsp;Width</label>
        <input type="number" id="node-input-width" style="width:125px !important">
    </div>
    <div class="form-row">
        <label for="node-input-rows"><i class="fa fa-line-chart"></i>Rows</label>
        <input type="number" id="node-input-rows">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/html" data-help-name="table-viewer">
    <p>Simple tabular data viewer for previewing data in sql result like format.
    <p><strong>Height:</strong><br/>
    The height (in pixels) of the viewer.</p>  
    <p><strong>Width:</strong><br/>
    The width (in pixels) of the viewer.</p>
    <p><strong>Num rows:</strong><br/>
    The number of rows to display in the table.</p>          
</script>